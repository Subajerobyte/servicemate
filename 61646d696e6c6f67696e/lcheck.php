<?phpini_set('memory_limit','1024M');include('../session.php');	include('../mukkiyam/dbc.php');include('../mukkiyam/db.php');// Import PHPMailer classes at the topuse PHPMailer\PHPMailer\PHPMailer;use PHPMailer\PHPMailer\SMTP;use PHPMailer\PHPMailer\Exception;// Load Composer's autoloaderrequire_once '../../1637028036/vendor/phpmailer/src/Exception.php';require_once '../../1637028036/vendor/phpmailer/src/PHPMailer.php';require_once '../../1637028036/vendor/phpmailer/src/SMTP.php';		function jbsencrypt($key, $str){$privateKey 	= 'WERULETHEWORLD';    $secretKey 		= $key;     $encryptMethod      = "AES-256-CBC";    $string 		= $str;    $key = hash('sha256', $privateKey);    $ivalue = substr(hash('sha256', $secretKey), 0, 16);     $result = openssl_encrypt($string, $encryptMethod, $key, 0, $ivalue);    return $output = base64_encode($result);  }	function jbsdecrypt($key, $str){	$privateKey 	= 'WERULETHEWORLD';     $secretKey 		= $key;     $encryptMethod      = "AES-256-CBC";    $stringEncrypt      = $str;     $key    = hash('sha256', $privateKey);    $ivalue = substr(hash('sha256', $secretKey), 0, 16); // sha256 is hash_hmac_algo    return $output = openssl_decrypt(base64_decode($stringEncrypt), $encryptMethod, $key, 0, $ivalue);}function adjustBrightness($hexCode, $adjustPercent) {    $hexCode = ltrim($hexCode, '#');    if (strlen($hexCode) == 3) {        $hexCode = $hexCode[0] . $hexCode[0] . $hexCode[1] . $hexCode[1] . $hexCode[2] . $hexCode[2];    }    $hexCode = array_map('hexdec', str_split($hexCode, 2));    foreach ($hexCode as & $color) {        $adjustableLimit = $adjustPercent < 0 ? $color : 255 - $color;        $adjustAmount = ceil($adjustableLimit * $adjustPercent);        $color = str_pad(dechex($color + $adjustAmount), 2, '0', STR_PAD_LEFT);    }    return '#' . implode($hexCode);}/* echo '<br>';$enc=jbsencrypt($key, "Test String");echo $enc.'<br>';$dec=jbsdecrypt($key, $enc);echo $dec.'<br>'; */function sendNotifications($title,$playerid,$message,$companysiteurl,$calltid){   $content = array(     "en" => $message     );	 $headings = array(     "en" => $title     );   $fields = array(     'app_id' => "2c0c6d16-4604-4e32-9514-38b6fdb1d3ee",     'include_player_ids' => array($playerid),	 'headings' => $headings,	 'large_icon' =>"https://jerobyte.com/1637028036/img/jerobytelogo.png",	 'url'=> "https://jerobyte.com/".$companysiteurl."/656e67696e6565726c6f67696e/calls.php?status=0",     'contents' => $content   );   $fields = json_encode($fields);   $ch = curl_init();   curl_setopt($ch, CURLOPT_URL, "https://onesignal.com/api/v1/notifications");   curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json; charset=utf-8',                      'Authorization: Basic NTY4NTI1NmQtNDg1My00NjI0LWJlNjktMDA0NzliZTQxM2E3'));   curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);   curl_setopt($ch, CURLOPT_HEADER, FALSE);   curl_setopt($ch, CURLOPT_POST, TRUE);   curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);   curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);   $response = curl_exec($ch);   curl_close($ch);   return $response; }function sendmail($mailer, $companyname,$subject,$body,$mailname,$apppassword,$addaddress){	if($mailer=="1")	{	// Instantiation$mail = new PHPMailer(true);// Server settings$mail->isSMTP();$mail->SMTPDebug = 0;$mail->Debugoutput = 'html';$mail->Host = 'smtp.gmail.com';$mail->SMTPAuth = true;$mail->SMTPSecure= 'tls';$mail->Port = 587;$mail->Username = $mailname;$mail->Password = $apppassword;$mail->From = $mailname;$mail->FromName = $companyname." - Jerobyte.com";$mail->addAddress($addaddress);// Content$mail->isHTML(true);$mail->CharSet = 'UTF-8';$mail->Encoding = 'base64';$mail->Subject = $subject;$body = $body;$mail->Body = $body;if($mail->send()){  //echo 'Success Message';//  exit;}else{  //echo 'Error Message';  //exit;}	}	else	{		$mail = new PHPMailer(true); // create a new object			$mail->isSMTP();			$mail->Host = 'localhost';			$mail->SMTPAuth = false;			$mail->SMTPAutoTLS = false; 			$mail->Port = 25; 			$mail->IsHTML(true);			$mail->Username = "alerts@jerobyte.com";			$mail->Password = "pretO@#*^JOPJWER1";			$mail->SetFrom("alerts@jerobyte.com", $_SESSION['companyname']." - Jerobyte.com");			$mail->AddAddress($addaddress);			$mail->addReplyTo($_SESSION['companyemail']);			$mail->AddCC($_SESSION['companyemail']);			$mail->Subject =$subject ;			$mail->Body    = $body;						if(!$mail->Send()) {					//echo 'error';				 } else {					 //echo 'sent';				 }	}}global $wrongPwdErr, $accountNotExistErr, $emailPwdErr, $verificationRequiredErr, $email_empty_err, $pass_empty_err;if(isset($_SESSION['logged_in'])) {$email_signin=$_SESSION['email'];$password_signin=$_SESSION['kadavuchol'];// clean data $user_email = filter_var($email_signin, FILTER_SANITIZE_EMAIL);$pswd = mysqli_real_escape_string($connection, $password_signin); $sql = "SELECT * From jrcadminuser WHERE username = '{$email_signin}' ";$query = mysqli_query($connection, $sql);$rowCount = mysqli_num_rows($query); if(!$query){ die("SQL query failed: " . mysqli_error($connection));}if(!empty($email_signin) && !empty($password_signin)){if(!preg_match("/^(?=.*\d)(?=.*[@#\-_$%^&+=ยง!\?])(?=.*[a-z])(?=.*[A-Z])[0-9A-Za-z@#\-_$%^&+=ยง!\?]{6,20}$/", $pswd)) {$wrongPwdErr = '<div class="alert alert-danger">Password should be between 6 to 20 charcters long, contains atleast one special chacter, lowercase, uppercase and a digit.</div>';} if($rowCount <= 0) {header("Location:../logout.php");} else {// Fetch user data and store in php sessionwhile($row = mysqli_fetch_array($query)) {$id= $row['id'];$adminuserid = $row['id'];$adminusername = $row['adminusername'];$designation= $row['designation'];$email = $row['username'];$pass_word = $row['password'];$useremail=$email;$address1 = $row['address1'];$address2 = $row['address2'];$area = $row['area'];$district = $row['district'];$pincode = $row['pincode'];$contact = $row['contact'];$mobile = $row['mobile'];$phone = $row['phone'];$avatar = $row['avatar'];$enabled = $row['enabled'];$sqlcompany = "SELECT companyid, companyname, companyshortname, address1, address2, area, district, statecode, gstno, cinno, pincode, contact, phone, mobile,mobile1,mobile2, email, latlong, avatar, salesemail, panno, bankname, qrcode, acno, branchname, ifscode,perkm, authsign, companyseal, preventive, preventivealert, warrantyexpire, amcexpire, amcmaintenance, amcmaintenancealert, amcrenewal, lifetime,footerimage,headerimage,mailer,apppassword, mailname, callhandlingid, coordinatorid, gstreg, legalname, tradename, gstregon, comscheme, comschemeval, revcharge,bgcolor, textcolor,amcmaintype,serprefix,amcprefix,estprefix,shortname,currentyear,financialyear,month,runningserial,notificationview,last_notification_update,somail,authtoken,tokenexpiry,etokenexpiry From jrccompany";$querycompany = mysqli_query($connection, $sqlcompany);$infocompany = mysqli_fetch_array($querycompany);$companyid=$infocompany['companyid'];$sqlcompany1 = "SELECT id, siteurl, salesmodule, businesstype, encsystem, secsystem, encliveip, enclocalip, encport, dbloc, empcur, empmax, slotmax, empprice, valexp, liveplan,presales,sales,postsales,branch,imagesize From jrccompany where id='".$infocompany['companyid']."'";$querycompany1 = mysqli_query($connection1, $sqlcompany1);$infocompany1 = mysqli_fetch_array($querycompany1);$_SESSION['companyid']=mysqli_real_escape_string($connection, $infocompany1['id']);$_SESSION['companysiteurl']=mysqli_real_escape_string($connection, $infocompany1['siteurl']);$_SESSION['companyname']=mysqli_real_escape_string($connection, $infocompany['companyname']);$_SESSION['companyshortname']=mysqli_real_escape_string($connection, $infocompany['companyshortname']);$_SESSION['companyaddress1']=mysqli_real_escape_string($connection, $infocompany['address1']);$_SESSION['somail']=mysqli_real_escape_string($connection, $infocompany['somail']);$_SESSION['companyaddress2']=mysqli_real_escape_string($connection, $infocompany['address2']);$_SESSION['companyarea']=mysqli_real_escape_string($connection, $infocompany['area']);$_SESSION['companydistrict']=mysqli_real_escape_string($connection, $infocompany['district']);$_SESSION['companystatecode']=mysqli_real_escape_string($connection, $infocompany['statecode']);$_SESSION['companygstno']=mysqli_real_escape_string($connection, $infocompany['gstno']);$_SESSION['companycinno']=mysqli_real_escape_string($connection, $infocompany['cinno']);$_SESSION['companypincode']=mysqli_real_escape_string($connection, $infocompany['pincode']);$_SESSION['companycontact']=mysqli_real_escape_string($connection, $infocompany['contact']);$_SESSION['companyphone']=mysqli_real_escape_string($connection, $infocompany['phone']);$_SESSION['companymobile']=mysqli_real_escape_string($connection, $infocompany['mobile']);$_SESSION['companymobile1']=mysqli_real_escape_string($connection, $infocompany['mobile1']);$_SESSION['companymobile2']=mysqli_real_escape_string($connection, $infocompany['mobile2']);$_SESSION['companyemail']=mysqli_real_escape_string($connection, $infocompany['email']);$_SESSION['companylatlong']=mysqli_real_escape_string($connection, $infocompany['latlong']);$_SESSION['companylogo']=mysqli_real_escape_string($connection, $infocompany['avatar']);$_SESSION['companyseal']=mysqli_real_escape_string($connection, $infocompany['companyseal']);$_SESSION['companysalesemail']=mysqli_real_escape_string($connection, $infocompany['salesemail']);$_SESSION['companypanno']=mysqli_real_escape_string($connection, $infocompany['panno']);$_SESSION['companybankname']=mysqli_real_escape_string($connection, $infocompany['bankname']);$_SESSION['companyqrcode']=mysqli_real_escape_string($connection, $infocompany['qrcode']);$_SESSION['companyacno']=mysqli_real_escape_string($connection, $infocompany['acno']);$_SESSION['companybranchname']=mysqli_real_escape_string($connection, $infocompany['branchname']);$_SESSION['companyifscode']=mysqli_real_escape_string($connection, $infocompany['ifscode']);$_SESSION['companyperkm']=mysqli_real_escape_string($connection, $infocompany['perkm']);$_SESSION['companyheaderimage']=mysqli_real_escape_string($connection, $infocompany['headerimage']);$_SESSION['companyfooterimage']=mysqli_real_escape_string($connection, $infocompany['footerimage']);$_SESSION['companyauthsign']=mysqli_real_escape_string($connection, $infocompany['authsign']);$_SESSION['preventive']=mysqli_real_escape_string($connection, $infocompany['preventive']);$_SESSION['preventivealert']=mysqli_real_escape_string($connection, $infocompany['preventivealert']);$_SESSION['warrantyexpire']=mysqli_real_escape_string($connection, $infocompany['warrantyexpire']);$_SESSION['amcmaintenance']=mysqli_real_escape_string($connection, $infocompany['amcmaintenance']);$_SESSION['amcmaintenancealert']=mysqli_real_escape_string($connection, $infocompany['amcmaintenancealert']);$_SESSION['amcexpire']=mysqli_real_escape_string($connection, $infocompany['amcexpire']);$_SESSION['amcrenewal']=mysqli_real_escape_string($connection, $infocompany['amcrenewal']);$_SESSION['lifetime']=mysqli_real_escape_string($connection, $infocompany['lifetime']);$_SESSION['mailer']=mysqli_real_escape_string($connection, $infocompany['mailer']);$_SESSION['mailname']=mysqli_real_escape_string($connection, $infocompany['mailname']);$_SESSION['callhandlingid']=mysqli_real_escape_string($connection, $infocompany['callhandlingid']);$_SESSION['coordinatorid']=mysqli_real_escape_string($connection, $infocompany['coordinatorid']);$_SESSION['apppassword']=mysqli_real_escape_string($connection, $infocompany['apppassword']);$_SESSION['gstreg']=mysqli_real_escape_string($connection, $infocompany['gstreg']);$_SESSION['legalname']=mysqli_real_escape_string($connection, $infocompany['legalname']);$_SESSION['tradename']=mysqli_real_escape_string($connection, $infocompany['tradename']);$_SESSION['gstregon']=mysqli_real_escape_string($connection, $infocompany['gstregon']);$_SESSION['comscheme']=mysqli_real_escape_string($connection, $infocompany['comscheme']);$_SESSION['comschemeval']=mysqli_real_escape_string($connection, $infocompany['comschemeval']);$_SESSION['revcharge']=mysqli_real_escape_string($connection, $infocompany['revcharge']);$_SESSION['bgcolor']=mysqli_real_escape_string($connection, $infocompany['bgcolor']);$_SESSION['textcolor']=mysqli_real_escape_string($connection, $infocompany['textcolor']);$_SESSION['amcmaintype']=mysqli_real_escape_string($connection, $infocompany['amcmaintype']);$_SESSION['imagesize']=mysqli_real_escape_string($connection, $infocompany1['imagesize']);$_SESSION['lightbgcolor']=adjustBrightness($_SESSION['bgcolor'],'0.5');$_SESSION['lightbgcolor1']=adjustBrightness($_SESSION['bgcolor'],'0.7');$_SESSION['lightbgcolor2']=adjustBrightness($_SESSION['bgcolor'],'0.9');$_SESSION['darkcolor']=adjustBrightness($_SESSION['bgcolor'],'-0.2');$_SESSION['amcprefix']=mysqli_real_escape_string($connection, $infocompany['amcprefix']);$_SESSION['serprefix']=mysqli_real_escape_string($connection, $infocompany['serprefix']);$_SESSION['estprefix']=mysqli_real_escape_string($connection, $infocompany['estprefix']);$_SESSION['companyshortname']=mysqli_real_escape_string($connection, $infocompany['companyshortname']);$_SESSION['notificationview']=mysqli_real_escape_string($connection, $infocompany['notificationview']);$_SESSION['last_notification_update']=mysqli_real_escape_string($connection, $infocompany['last_notification_update']);$_SESSION['authtoken']=mysqli_real_escape_string($connection, $infocompany['authtoken']);$_SESSION['tokenexpiry']=mysqli_real_escape_string($connection, $infocompany['tokenexpiry']);$_SESSION['etokenexpiry']=mysqli_real_escape_string($connection, $infocompany['etokenexpiry']);$_SESSION['currentyear']='';$_SESSION['financialyear']='';$_SESSION['shortname']='';$_SESSION['month']='';$_SESSION['runningserial']='';if($infocompany['shortname']=='Company Short Name'){$_SESSION['shortname']=$_SESSION['companyshortname'];}if($infocompany['currentyear']=='2-Digit Current Year'){$_SESSION['currentyear']=date('y');}else if($infocompany['currentyear']=='4-Digit Current Year'){$_SESSION['currentyear']=date('Y');}if($infocompany['financialyear']=='Financial Year 2 digit Start & End'){if(date('m') >= 4){$currentyear=date('y');$nextyear=date('y')+1;$_SESSION['financialyear']=$currentyear.$nextyear;}}else if($infocompany['financialyear']=='Financial Year 4 digit Start & End'){if(date('m') >= 4){$currentyear=date('Y');$nextyear=date('Y')+1;$_SESSION['financialyear']=$currentyear.$nextyear;}}if($infocompany['month']=='2-Digit Month'){$_SESSION['month']=date('m');}else if($infocompany['month']=='Month In Alphabet'){$_SESSION['month']=date('M');}$businesstype=mysqli_real_escape_string($connection1, $infocompany1['businesstype']);$businesstypesarray=explode(',',$businesstype);$empmax=mysqli_real_escape_string($connection1, $infocompany1['empmax']);$empcur=mysqli_real_escape_string($connection1, $infocompany1['empcur']);$slotmax=mysqli_real_escape_string($connection1, $infocompany1['slotmax']);$empprice=mysqli_real_escape_string($connection1, $infocompany1['empprice']);$dbloc=mysqli_real_escape_string($connection1, $infocompany1['dbloc']);$valexp=mysqli_real_escape_string($connection1, $infocompany1['valexp']);$secsystem=mysqli_real_escape_string($connection1, $infocompany1['secsystem']);$encsystem=mysqli_real_escape_string($connection1, $infocompany1['encsystem']);if(($infocompany1['encsystem']=='1')||($infocompany1['encsystem']=='2')){	if(!isset($_SESSION['encpass']))	{		header("Location: ../logout.php");	}}$salesmodule=mysqli_real_escape_string($connection1, $infocompany1['salesmodule']);$liveplan=mysqli_real_escape_string($connection1, $infocompany1['liveplan']);$branch=mysqli_real_escape_string($connection1, $infocompany1['branch']);$presales=mysqli_real_escape_string($connection1, $infocompany1['presales']);$sales=mysqli_real_escape_string($connection1, $infocompany1['sales']);$postsales=mysqli_real_escape_string($connection1, $infocompany1['postsales']);$sqlselectaccess = "SELECT * From jrcuseraccess where userid='".$id."' order by id asc";$queryselectaccess = mysqli_query($connection, $sqlselectaccess);$rowCountselectaccess = mysqli_num_rows($queryselectaccess);$rowselectaccess = mysqli_fetch_array($queryselectaccess);$calladd=mysqli_real_escape_string($connection, $rowselectaccess['calladd']);$calledit=mysqli_real_escape_string($connection, $rowselectaccess['calledit']);$callview=mysqli_real_escape_string($connection, $rowselectaccess['callview']);$callchange=mysqli_real_escape_string($connection,$rowselectaccess['callchange']);$callreport=mysqli_real_escape_string($connection, $rowselectaccess['callreport']);$servicereport=mysqli_real_escape_string($connection, $rowselectaccess['servicereport']);$ticket=mysqli_real_escape_string($connection, $rowselectaccess['ticket']);$engineerta=mysqli_real_escape_string($connection, $rowselectaccess['engineerta']);$addconsignee=mysqli_real_escape_string($connection, $rowselectaccess['addconsignee']);$addamc=mysqli_real_escape_string($connection, $rowselectaccess['addamc']);$exportreport=mysqli_real_escape_string($connection, $rowselectaccess['exportreport']);$addinvoice=mysqli_real_escape_string($connection, $rowselectaccess['addinvoice']);$deleteproduct=mysqli_real_escape_string($connection, $rowselectaccess['deleteproduct']);$warrantymanagement=mysqli_real_escape_string($connection, $rowselectaccess['warrantymanagement']);$amcmanagement=mysqli_real_escape_string($connection, $rowselectaccess['amcmanagement']);$sellprice=mysqli_real_escape_string($connection, $rowselectaccess['sellprice']);$livelocation=mysqli_real_escape_string($connection, $rowselectaccess['livelocation']);$engineerperformance=mysqli_real_escape_string($connection, $rowselectaccess['engineerperformance']);$servicecharges=mysqli_real_escape_string($connection, $rowselectaccess['servicecharges']);$salesorder=mysqli_real_escape_string($connection, $rowselectaccess['salesorder']);$exportconsignee=mysqli_real_escape_string($connection, $rowselectaccess['exportconsignee']);$exportinvoice=mysqli_real_escape_string($connection, $rowselectaccess['exportinvoice']);$uploaddata=mysqli_real_escape_string($connection, $rowselectaccess['uploaddata']);$usercreation=mysqli_real_escape_string($connection, $rowselectaccess['usercreation']);$settings=mysqli_real_escape_string($connection, $rowselectaccess['settings']);$updates=mysqli_real_escape_string($connection, $rowselectaccess['updates']);$sqllayoutcustomers=mysqli_query($connection, "select * from jrclayoutcustomers");$infolayoutcustomers=mysqli_fetch_array($sqllayoutcustomers);$sqllayoutproducts=mysqli_query($connection, "select * from jrclayoutproducts");$infolayoutproducts=mysqli_fetch_array($sqllayoutproducts);if($valexp!=""){$valdate1 = date('Y-m-d');$valdate2 = $valexp;$diff = strtotime($valdate2) - strtotime($valdate1);$years = floor($diff / (365*60*60*24));$months = floor(($diff - $years * 365*60*60*24) / (30*60*60*24));$valintervaldays = floor(($diff)/ (60*60*24));if($valintervaldays<-14){	session_unset();	session_destroy();	if (isset($_SERVER['HTTP_COOKIE'])) {		$cookies = explode(';', $_SERVER['HTTP_COOKIE']);		foreach($cookies as $cookie) {			$parts = explode('=', $cookie);			$name = trim($parts[0]);			setcookie($name, '', time()-1000);			setcookie($name, '', time()-1000, '/');		}	}	header("Location: ../index.php?error=Your Subscription Validity has been Expired. Kindly Renew your Subscription Period");}}//$currentDateTime = new DateTime();//$expiryDateTime = new DateTime($_SESSION['tokenexpiry']);$currentDateTime = date('Y-m-d H:i:s');$expiryDateTime = $_SESSION['tokenexpiry'];if ($currentDateTime >= $expiryDateTime) {	// Your API endpoint$url = 'https://api.mastergst.com/einvoice/authenticate?email=ijerald%40jerobyte.com';$curl = curl_init($url);curl_setopt($curl, CURLOPT_URL, $url);curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);$headers = array(    "accept: */*",    "username: jrcommpl_API_jbs",    "password: Rohan*123",    "ip_address: 192.168.1.111",    "client_id: 9823d6bc-0c3a-4297-ac49-165fe7e22b42",    "client_secret: c54de1ec-f55f-4757-81fe-a74f4fceb35e",    "gstin: 33AACCJ5647F1ZP",);curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);$resp = curl_exec($curl);if (curl_errno($curl)) {    $error_message = "Error making API request: " . curl_error($curl);    curl_close($curl);    //header("Location: exporttally.php?error=" . urlencode($error_message));}curl_close($curl);if ($resp) {    $responseData = json_decode($resp, true);    if (isset($responseData['status_cd']) && strtolower($responseData['status_cd']) === "sucess") {        $tokenExpiry = isset($responseData['data']['TokenExpiry']) ? $responseData['data']['TokenExpiry'] : '';        $authToken = isset($responseData['data']['AuthToken']) ? $responseData['data']['AuthToken'] : '';		 $updateQuery = "UPDATE jrccompany SET tokenexpiry='$tokenExpiry', authtoken='$authToken'";         $result = mysqli_query($connection, $updateQuery);        if ($result) {			//var_dump($resp);          //  header("Location: exporttally.php?remarks=Token expiry and auth token updated successfully");                    } else {            $error_message = "Error updating database: " . mysqli_error($connection);           // header("Location: exporttally.php?error=" . urlencode($error_message));                   }    } else {       // var_dump($resp);        $error_message = "API request was not successful or missing required data";       // header("Location: exporttally.php?error=" . urlencode($error_message));            }} else {    $error_message = "Invalid API response or no response received";   // header("Location: exporttally.php?error=" . urlencode($error_message));    }}}if($enabled == '0') {if($email_signin == $email && $password_signin == md5($pass_word)) {} else {header("Location:../logout.php");}} else {header("Location:../logout.php");}}} else {header("Location:../logout.php"); }}else{header("Location:../logout.php");}?>